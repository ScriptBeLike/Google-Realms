<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Realms | Infinite 3D Asset Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #F8F9FA;
            color: #202124;
            overflow-x: hidden;
        }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #dadce0; border-radius: 4px; }

        .btn-primary {
            background-color: #1a73e8;
            color: white;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #1557b0;
            box-shadow: 0 1px 3px rgba(60,64,67,0.3);
        }

        .category-tab.active {
            color: #1a73e8;
            border-bottom: 3px solid #1a73e8;
            font-weight: 500;
        }
        
        .modal-overlay {
            background-color: rgba(32, 33, 36, 0.7);
            backdrop-filter: blur(8px);
        }

        .card-hover:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateY(-4px);
        }

        .material-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .material-circle:hover { transform: scale(1.1); }
        
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #323232;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        .loader-dots div {
            width: 10px;
            height: 10px;
            margin: 0 4px;
            background: #4285F4;
            border-radius: 50%;
            display: inline-block;
            animation: bounce 0.6s infinite alternate;
        }
        .loader-dots div:nth-child(2) { animation-delay: 0.2s; background: #EA4335; }
        .loader-dots div:nth-child(3) { animation-delay: 0.4s; background: #FBBC05; }
        
        @keyframes bounce { to { transform: translateY(-10px); } }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-white sticky top-0 z-40 border-b border-gray-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center cursor-pointer" onclick="location.reload()">
                <svg class="w-8 h-8 mr-2" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2L2 7L12 12L22 7L12 2Z" fill="#EA4335"/>
                    <path d="M2 17L12 22L22 17V12L12 17L2 12V17Z" fill="#34A853"/>
                    <path d="M2 12L12 17L22 12V7L12 12L2 7V12Z" fill="#4285F4"/>
                    <path d="M12 12L22 7V12L12 17V12Z" fill="#FBBC05"/>
                </svg>
                <span class="text-xl font-medium tracking-tight text-gray-700">
                    <span class="font-bold text-gray-800">Google</span> Realms
                </span>
            </div>

            <div class="flex-1 max-w-2xl mx-8 hidden md:block">
                <form id="searchForm" class="relative group">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </div>
                    <input type="text" id="searchInput" class="block w-full pl-11 pr-4 py-2.5 border border-gray-300 rounded-full bg-gray-50 focus:outline-none focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" placeholder="Search the infinite library of 3D models...">
                </form>
            </div>

            <div class="flex items-center space-x-2">
                <div class="h-9 w-9 rounded-full bg-gray-100 border border-gray-200 text-gray-500 flex items-center justify-center font-bold">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                </div>
            </div>
        </div>
    </header>

    <div class="bg-white border-b border-gray-200 sticky top-16 z-30">
        <div class="max-w-7xl mx-auto px-4 overflow-x-auto">
            <nav class="flex space-x-8" id="categoryNav">
                <button class="category-tab active py-4 px-1 text-sm font-medium whitespace-nowrap" data-query="3d-models">Featured</button>
                <button class="category-tab py-4 px-1 text-sm font-medium whitespace-nowrap" data-query="architecture">Architecture</button>
                <button class="category-tab py-4 px-1 text-sm font-medium whitespace-nowrap" data-query="characters">Characters</button>
                <button class="category-tab py-4 px-1 text-sm font-medium whitespace-nowrap" data-query="vehicles">Vehicles</button>
                <button class="category-tab py-4 px-1 text-sm font-medium whitespace-nowrap" data-query="scenery">Scenery</button>
                <button class="category-tab py-4 px-1 text-sm font-medium whitespace-nowrap" data-query="gadgets">Tech</button>
            </nav>
        </div>
    </div>

    <main class="flex-grow max-w-7xl mx-auto px-4 py-8 w-full">
        <div id="assetGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>
        <div id="loader" class="flex flex-col items-center justify-center py-12 space-y-4 opacity-0 transition-opacity duration-300">
            <div class="loader-dots"><div></div><div></div><div></div></div>
            <p class="text-sm text-gray-400 font-medium">Fetching more assets from the Realm...</p>
        </div>
    </main>

    <div id="viewerModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-overlay absolute inset-0" onclick="closeModal()"></div>
        <div class="absolute inset-4 md:inset-10 bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            <div class="flex items-center justify-between px-6 py-4 border-b">
                <div class="flex items-center space-x-3">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <div>
                        <h2 class="text-lg font-bold" id="modalTitle">Loading Asset...</h2>
                        <p class="text-[10px] text-gray-400 uppercase tracking-widest font-bold">Realms Production Preview</p>
                    </div>
                </div>
                <button class="text-gray-400 hover:text-gray-600 p-2" onclick="closeModal()">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="flex-1 bg-[#121212] relative">
                <iframe id="sfIframe" class="w-full h-full border-0" allow="autoplay; fullscreen; vr"></iframe>
            </div>
            <div class="p-6 border-t bg-gray-50 flex flex-col md:flex-row md:items-center justify-between gap-6">
                <div class="flex flex-col">
                    <span class="text-[10px] font-black text-gray-400 uppercase mb-3 tracking-tighter">Surface Material Analysis</span>
                    <div class="flex space-x-3" id="materialCircles"></div>
                </div>
                <div class="flex items-center space-x-3">
                    <button class="px-6 py-2.5 rounded-xl border border-gray-300 text-sm font-semibold hover:bg-white transition-colors" onclick="downloadAsset()">Add to Workspace</button>
                    <button class="btn-primary px-8 py-2.5 rounded-xl text-sm font-semibold shadow-md" onclick="downloadAsset()">Download GLB/USDZ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast">Asset added to your local Realm library.</div>

    <script>
        const API_BASE = "https://api.sketchfab.com/v3/search";
        let nextUrl = null;
        let isFetching = false;
        let currentSearch = "";
        let currentCategory = "3d-models";

        const grid = document.getElementById('assetGrid');
        const loader = document.getElementById('loader');
        const searchInput = document.getElementById('searchInput');
        const searchForm = document.getElementById('searchForm');
        const modal = document.getElementById('viewerModal');
        const iframe = document.getElementById('sfIframe');

        async function fetchModels(isNew = false) {
            if (isFetching) return;
            if (!isNew && !nextUrl) return;

            isFetching = true;
            loader.style.opacity = '1';

            let targetUrl;
            if (isNew) {
                targetUrl = `${API_BASE}?type=models&q=${encodeURIComponent(currentSearch || currentCategory)}`;
            } else {
                targetUrl = nextUrl;
            }

            // Safety check for URL validity
            if (!targetUrl || typeof targetUrl !== 'string' || !targetUrl.startsWith('http')) {
                console.error("Invalid fetch target:", targetUrl);
                isFetching = false;
                loader.style.opacity = '0';
                return;
            }

            if (isNew) grid.innerHTML = "";

            try {
                const response = await fetch(targetUrl);
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                const data = await response.json();
                
                // SKETCHFAB API: Properly capture the next cursor/page
                // We prioritize the full URL provided in cursors.next
                if (data.cursors && typeof data.cursors.next === 'string' && data.cursors.next.startsWith('http')) {
                    nextUrl = data.cursors.next;
                } 
                // Fallback: manually construct if just an offset/cursor is provided
                else if (data.cursors && data.cursors.next) {
                    nextUrl = `${API_BASE}?type=models&q=${encodeURIComponent(currentSearch || currentCategory)}&cursor=${data.cursors.next}`;
                } else {
                    nextUrl = null; 
                }
                
                if (data.results && data.results.length > 0) {
                    renderModels(data.results);
                }
            } catch (error) {
                console.error("Fetch Error:", error);
            } finally {
                isFetching = false;
                setTimeout(() => {
                    loader.style.opacity = nextUrl ? '1' : '0';
                }, 500);
            }
        }

        function renderModels(results) {
            results.forEach(model => {
                if (!model.thumbnails?.images?.length) return;
                const thumb = model.thumbnails.images.sort((a,b) => b.width - a.width)[0].url;
                const card = document.createElement('div');
                card.className = "bg-white rounded-2xl overflow-hidden border border-gray-100 cursor-pointer card-hover flex flex-col h-full group transition-all";
                card.onclick = () => openModal(model.uid, model.name);
                card.innerHTML = `
                    <div class="h-52 bg-gray-100 relative overflow-hidden">
                        <img src="${thumb}" alt="${model.name}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" loading="lazy">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div class="absolute top-3 left-3 bg-white/90 backdrop-blur px-2 py-0.5 rounded text-[10px] font-bold text-gray-700 shadow-sm border border-white/50">3D</div>
                    </div>
                    <div class="p-4 flex-grow flex flex-col">
                        <h3 class="font-bold text-gray-800 text-sm mb-1 line-clamp-1 group-hover:text-blue-600 transition-colors">${model.name || 'Anonymous Asset'}</h3>
                        <p class="text-[11px] text-gray-400 font-bold uppercase tracking-wide">Artist: ${model.user?.username || 'Legacy'}</p>
                        <div class="mt-auto pt-4 flex items-center justify-between">
                            <div class="flex items-center space-x-1">
                                <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span>
                                <span class="text-[10px] font-black text-blue-500 uppercase">Available</span>
                            </div>
                            <div class="text-[11px] text-gray-400 flex items-center">
                                <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg>
                                ${model.viewCount ? (model.viewCount > 1000 ? (model.viewCount / 1000).toFixed(1) + 'k' : model.viewCount) : '0'}
                            </div>
                        </div>
                    </div>`;
                grid.appendChild(card);
            });
        }

        searchForm.onsubmit = (e) => {
            e.preventDefault();
            currentSearch = searchInput.value.trim();
            nextUrl = null;
            fetchModels(true);
        };

        document.getElementById('categoryNav').onclick = (e) => {
            if (e.target.tagName === 'BUTTON') {
                document.querySelectorAll('.category-tab').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentCategory = e.target.dataset.query;
                currentSearch = "";
                searchInput.value = "";
                nextUrl = null;
                fetchModels(true);
            }
        };

        function openModal(uid, name) {
            document.getElementById('modalTitle').innerText = name;
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            iframe.src = `https://sketchfab.com/models/${uid}/embed?autostart=1&internal=1&tracking=0&ui_ar=0&ui_infos=0&ui_watermark=0&ui_theme=dark`;
            const container = document.getElementById('materialCircles');
            container.innerHTML = '';
            const palette = ['#4285F4', '#EA4335', '#FBBC05', '#34A853', '#777', '#111', '#ddd', '#a6c'];
            for(let i=0; i<5; i++) {
                const div = document.createElement('div');
                div.className = "material-circle";
                div.style.backgroundColor = palette[Math.floor(Math.random() * palette.length)];
                container.appendChild(div);
            }
        }

        function closeModal() {
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
            iframe.src = '';
        }

        function downloadAsset() {
            const toast = document.getElementById("toast");
            toast.className = "show";
            setTimeout(() => { toast.className = ""; }, 3000);
        }

        // Infinite Scroll Listener
        window.onscroll = () => {
            const scrollHeight = document.documentElement.scrollHeight;
            const scrollTop = window.innerHeight + window.scrollY;
            if (scrollHeight - scrollTop < 1200) { // Trigger further up for smoother loading
                fetchModels();
            }
        };

        window.onload = () => fetchModels(true);
    </script>
</body>
</html>
